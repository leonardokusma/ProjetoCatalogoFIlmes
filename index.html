<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineCat√°logo - Koncession√°rios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo Vidro com toque avermelhado */
        .glass { 
            background: rgba(20, 20, 20, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(220, 38, 38, 0.3); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        /* Anima√ß√£o suave */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        body { background-color: #050505; color: #e5e5e5; }
    </style>
</head>
<body class="font-sans min-h-screen flex flex-col">

    <div id="loginScreen" class="flex flex-col items-center justify-center min-h-screen bg-[url('https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-black/80"></div> <div class="glass p-8 rounded-xl w-96 shadow-2xl z-10 fade-in">
            <h1 class="text-4xl font-extrabold mb-8 text-center text-red-600 tracking-tighter">NET<span class="text-white">FILMES</span></h1>
            <input type="email" id="email" placeholder="Email de Admin" class="w-full p-3 mb-4 bg-zinc-900 rounded border border-red-900/50 focus:border-red-600 outline-none text-white placeholder-gray-500 transition">
            <input type="password" id="senha" placeholder="Senha" class="w-full p-3 mb-6 bg-zinc-900 rounded border border-red-900/50 focus:border-red-600 outline-none text-white placeholder-gray-500 transition">
            <button onclick="fazerLogin()" class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-3 rounded transition shadow-[0_0_15px_rgba(220,38,38,0.5)]">ENTRAR</button>
            <p id="msgErro" class="text-red-400 text-sm mt-4 text-center hidden font-semibold"></p>
        </div>
    </div>

    <div id="appScreen" class="hidden container mx-auto p-6 flex-1">
        <header class="flex justify-between items-center mb-8 border-b border-red-900/30 pb-4">
            <h2 class="text-3xl font-bold text-red-600 tracking-tight">üé¨ <span class="text-white">Cat√°logo</span></h2>
            <div class="flex gap-4">
                <button onclick="sortearFilme()" class="flex items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white px-5 py-2 rounded font-bold shadow-lg transition transform hover:scale-105">
                    üé≤ Estou com Sorte
                </button>
                <button onclick="logout()" class="text-gray-400 hover:text-white border border-gray-600 hover:border-white px-4 py-2 rounded transition">Sair</button>
            </div>
        </header>

        <div class="glass p-6 rounded-lg mb-10 border-l-4 border-l-red-600">
            <h3 class="text-xl mb-4 font-semibold text-red-500 uppercase tracking-widest text-sm">Adicionar Novo T√≠tulo</h3>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <input type="text" id="novoNome" placeholder="T√≠tulo do Filme" class="md:col-span-2 p-3 bg-zinc-900 rounded border border-zinc-700 focus:border-red-500 outline-none text-white">
                <input type="text" id="novoDiretor" placeholder="Diretor" class="p-3 bg-zinc-900 rounded border border-zinc-700 focus:border-red-500 outline-none text-white">
                <input type="text" id="novoGenero" placeholder="G√™nero" class="p-3 bg-zinc-900 rounded border border-zinc-700 focus:border-red-500 outline-none text-white">
                <input type="number" id="novoAno" placeholder="Ano" class="p-3 bg-zinc-900 rounded border border-zinc-700 focus:border-red-500 outline-none text-white">
            </div>
            <button onclick="adicionarFilme()" class="mt-4 w-full md:w-auto bg-white text-black hover:bg-gray-200 px-8 py-3 rounded font-bold transition">
                + Adicionar ao Cat√°logo
            </button>
        </div>

        <div id="listaFilmes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>
    </div>

    <div id="modalSorte" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="glass p-8 rounded-2xl max-w-md w-full text-center relative border border-red-500/50 shadow-[0_0_50px_rgba(220,38,38,0.2)]">
            <button onclick="fecharModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            
            <div class="mb-6 text-6xl">üçø</div>
            <h2 class="text-sm text-red-500 uppercase tracking-widest mb-2">Sugest√£o Aleat√≥ria</h2>
            <h1 id="modalTitulo" class="text-3xl font-bold text-white mb-4 leading-tight">...</h1>
            
            <div class="flex justify-center gap-4 text-sm text-gray-400 mb-6">
                <span id="modalAno" class="bg-zinc-800 px-2 py-1 rounded">...</span>
                <span id="modalGenero" class="bg-zinc-800 px-2 py-1 rounded">...</span>
            </div>
            
            <p id="modalDiretor" class="text-lg text-gray-300 italic mb-8">...</p>
            
            <button onclick="fecharModal()" class="bg-red-600 hover:bg-red-500 text-white w-full py-3 rounded font-bold transition">
                Fechar
            </button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let token = localStorage.getItem('token');

        if(token) mostrarApp();

        // --- LOGIN ---
        async function fazerLogin() {
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            
            try {
                const response = await fetch(`${API_URL}/usuarios/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, senha }) 
                });
                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    mostrarApp();
                } else {
                    mostrarErro('Acesso Negado: ' + (data.error || 'Dados inv√°lidos'));
                }
            } catch (error) {
                mostrarErro('Backend offline ou erro de conex√£o.');
            }
        }

        // --- LISTAR FILMES ---
        async function carregarFilmes() {
            try {
                const response = await fetch(`${API_URL}/filmes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // 1. Verifica se o Backend retornou erro (401, 403, 500 etc)
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        throw new Error('N√£o autorizado (Token inv√°lido ou expirado)');
                    }
                    const erro = await response.json();
                    throw new Error(erro.message || 'Erro ao buscar filmes');
                }

                const filmes = await response.json();
                
                // 2. Garante que 'filmes' √© uma lista antes de tentar exibir
                if (!Array.isArray(filmes)) {
                    console.error("Formato inesperado:", filmes);
                    throw new Error("O backend n√£o retornou uma lista de filmes.");
                }

                const listaDiv = document.getElementById('listaFilmes');
                listaDiv.innerHTML = ''; 

                filmes.forEach(filme => {
                    listaDiv.innerHTML += `
                        <div class="glass p-5 rounded hover:bg-zinc-900 transition relative group border border-transparent hover:border-red-900/50">
                            <div class="flex justify-between items-start">
                                <span class="text-xs font-bold text-red-500 uppercase tracking-wider">${filme.genero || 'G√™nero n/a'}</span>
                                <span class="text-xs bg-zinc-800 text-gray-400 px-2 py-0.5 rounded">${filme.ano_lancamento || filme.anoLancamento}</span>
                            </div>
                            
                            <h3 class="text-xl font-bold text-white mt-2 mb-1 truncate">${filme.titulo || filme.nome}</h3> 
                            <p class="text-gray-400 text-sm italic">Dir. ${filme.diretor || 'Desconhecido'}</p>
                            
                            <button onclick="deletarFilme(${filme.id})" class="absolute bottom-4 right-4 text-red-600 opacity-0 group-hover:opacity-100 transition hover:text-red-400">
                                Excluir
                            </button>
                        </div>
                    `;
                });
            } catch (error) {
                console.error(error); // Veja o erro real no console (F12)
                
                // S√≥ desloga se for erro de autentica√ß√£o real
                if (error.message.includes('N√£o autorizado')) {
                    alert('Sess√£o expirada. Fa√ßa login novamente.');
                    logout();
                } else {
                    // Mostra o erro t√©cnico na tela sem deslogar
                    alert('Erro: ' + error.message);
                }
            }
        }

        // --- ADICIONAR FILME (COM NOVOS CAMPOS) ---
        async function adicionarFilme() {
            // Pegando valores
            const titulo = document.getElementById('novoNome').value; // Backend espera 'titulo' ou 'nome'? Ajuste aqui.
            const ano_lancamento = document.getElementById('novoAno').value;
            const diretor = document.getElementById('novoDiretor').value;
            const genero = document.getElementById('novoGenero').value;

            if(!titulo || !ano_lancamento) return alert('T√≠tulo e Ano s√£o obrigat√≥rios');

            const payload = {
                titulo, // ou nome: titulo
                ano_lancamento, // ou anoLancamento: ano_lancamento
                diretor,
                genero
            };

            const response = await fetch(`${API_URL}/filmes`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload) 
            });

            if(response.ok) {
                // Limpar campos
                document.getElementById('novoNome').value = '';
                document.getElementById('novoAno').value = '';
                document.getElementById('novoDiretor').value = '';
                document.getElementById('novoGenero').value = '';
                carregarFilmes();
            } else {
                alert('Erro ao salvar. Verifique se o backend aceita os novos campos.');
            }
        }

        // --- ESTOU COM SORTE (ALEAT√ìRIO) ---
        async function sortearFilme() {
            try {
                // Chama a rota que voc√™ criou no backend
                const response = await fetch(`${API_URL}/filmes/aleatorio`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if(!response.ok) throw new Error('Erro ao buscar');

                let filme = await response.json();
                if (Array.isArray(filme)) {
                    filme = filme[0];
                }
                
                // Preenche o Modal
                document.getElementById('modalTitulo').innerText = filme.titulo || filme.nome;
                document.getElementById('modalAno').innerText = filme.ano_lancamento || filme.anoLancamento;
                document.getElementById('modalGenero').innerText = filme.genero || 'G√™nero N/A';
                document.getElementById('modalDiretor').innerText = "Dirigido por " + (filme.diretor || 'Desconhecido');

                // Abre o Modal
                document.getElementById('modalSorte').classList.remove('hidden');
                
            } catch (e) {
                alert('N√£o foi poss√≠vel sortear um filme (Verifique se a rota /api/filmes/aleatorio existe)');
            }
        }

        function fecharModal() {
            document.getElementById('modalSorte').classList.add('hidden');
        }

        async function deletarFilme(id) {
            if(!confirm('Remover este filme do cat√°logo?')) return;
            await fetch(`${API_URL}/filmes/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            carregarFilmes();
        }

        function mostrarApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('fade-in');
            carregarFilmes();
        }

        function logout() {
            token = null;
            localStorage.removeItem('token');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
        }

        function mostrarErro(msg) {
            const el = document.getElementById('msgErro');
            el.innerText = msg;
            el.classList.remove('hidden');
        }
    </script>
</body>
</html>